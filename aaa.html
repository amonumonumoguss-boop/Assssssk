<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Tiger Hunter - Multi-Platform</title>
    <style>
        body { margin: 0; overflow: hidden; font-family: sans-serif; touch-action: none; background: #87ceeb; }
        
        /* VIEWMODEL VŨ KHÍ */
        #weapon-view {
            position: absolute; bottom: 0; right: 0; width: 40%; max-width: 450px;
            pointer-events: none; z-index: 5; transition: transform 0.1s;
        }

        /* TÂM NHẮM */
        #crosshair { position: absolute; top: 50%; left: 50%; width: 20px; height: 20px; transform: translate(-50%, -50%); pointer-events: none; z-index: 10; }
        #crosshair:before { content: ""; position: absolute; top: 9px; left: 0; width: 20px; height: 2px; background: #0f0; }
        #crosshair:after { content: ""; position: absolute; left: 9px; top: 0; width: 2px; height: 20px; background: #0f0; }

        /* HUD & MENU */
        #hud { position: absolute; top: 10px; left: 10px; color: white; text-shadow: 2px 2px #000; z-index: 20; pointer-events: none; }
        #mod-menu { position: absolute; top: 10px; right: 10px; z-index: 100; background: rgba(0,0,0,0.8); color: white; padding: 10px; border-radius: 8px; font-size: 11px; width: 160px; }
        .input-box { width: 90%; margin: 5px 0; background: #222; color: #0f0; border: 1px solid #444; padding: 4px; font-size: 10px; }
        .btn-ui { cursor: pointer; background: #444; color: white; border: none; padding: 5px; width: 100%; border-radius: 3px; margin-bottom: 5px; }

        /* MOBILE CONTROLS */
        .btn-ctrl { position: absolute; background: rgba(0,0,0,0.4); border: 2px solid white; border-radius: 50%; color: white; display: flex; justify-content: center; align-items: center; font-weight: bold; z-index: 20; user-select: none; }
        #fire-btn { bottom: 30px; right: 30px; width: 90px; height: 90px; background: rgba(255,0,0,0.5); }
        
        #joy-base { position: absolute; bottom: 50px; left: 50px; width: 100px; height: 100px; background: rgba(255,255,255,0.2); border-radius: 50%; display: none; }
        #joy-stk { position: absolute; top: 30px; left: 30px; width: 40px; height: 40px; background: white; border-radius: 50%; }

        #msg { position: absolute; top: 30%; width: 100%; text-align: center; color: red; font-size: 30px; font-weight: 900; display: none; text-shadow: 2px 2px #000; }
    </style>
</head>
<body>

    <div id="msg">DẦN VƯƠNG XUẤT THẾ!</div>
    <div id="hud">
        TIỀN: <span id="money">0</span>$<br>
        MỤC TIÊU: <span id="count">0</span><br>
        <small>(PC: WASD - Chuột trái bắn - Space nhảy)</small>
    </div>

    <div id="mod-menu">
        <b>⚙️ CÀI ĐẶT BASE64</b>
        <input type="text" id="b64-weapon" class="input-box" placeholder="Base64 Vũ Khí...">
        <button class="btn-ui" onclick="updateWeapon()">ĐỔI VŨ KHÍ</button>
        <input type="text" id="b64-tiger" class="input-box" placeholder="Base64 Hổ...">
        <button class="btn-ui" onclick="updateTiger()">ĐỔI SKIN HỔ</button>
        <button class="btn-ui" style="background:#600" onclick="money+=1000; updateUI();">HACK +1000$</button>
    </div>

    <img id="weapon-view" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAQAAAC1HAwCAAAAC0lEQVR42mNkYAAAAAYAAjCB0C8AAAAASUVORK5CYII=">
    <div id="crosshair"></div>
    
    <div id="joy-base"><div id="joy-stk"></div></div>
    <div id="fire-btn" class="btn-ctrl">BẮN</div>

    <script type="module">
        import * as THREE from 'https://cdn.jsdelivr.net/npm/three@0.132.2/build/three.module.js';

        let scene, camera, renderer, clock = new THREE.Clock();
        let targets = [], playerHP = 100, money = 0;
        let moveF = 0, moveS = 0, vVel = 0, isGrounded = true;
        let tigerTex = null;

        // PC Controls
        let keys = {};
        document.addEventListener('keydown', (e) => keys[e.code] = true);
        document.addEventListener('keyup', (e) => keys[e.code] = false);
        document.addEventListener('mousedown', () => { if(document.pointerLockElement) shoot(); else document.body.requestPointerLock(); });
        document.addEventListener('mousemove', (e) => {
            if(document.pointerLockElement) {
                camera.rotation.y -= e.movementX * 0.002;
                camera.rotation.x -= e.movementY * 0.002;
                camera.rotation.x = Math.max(-1.5, Math.min(1.5, camera.rotation.x));
            }
        });

        init();
        animate();

        function init() {
            scene = new THREE.Scene();
            scene.background = new THREE.Color(0x87ceeb);
            scene.fog = new THREE.Fog(0x87ceeb, 20, 200);

            camera = new THREE.PerspectiveCamera(75, window.innerWidth/window.innerHeight, 0.1, 1000);
            camera.rotation.order = 'YXZ';
            camera.position.set(0, 2, 0);

            renderer = new THREE.WebGLRenderer({ antialias: true });
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.setPixelRatio(window.devicePixelRatio);
            document.body.appendChild(renderer.domElement);

            scene.add(new THREE.AmbientLight(0xffffff, 0.8));
            const sun = new THREE.DirectionalLight(0xffffff, 0.5); sun.position.set(10, 50, 10); scene.add(sun);

            // Sàn đặc không xuyên thấu
            const floor = new THREE.Mesh(new THREE.BoxGeometry(1000, 2, 1000), new THREE.MeshStandardMaterial({ color: 0xffffff }));
            floor.position.y = -1;
            scene.add(floor);
            scene.add(new THREE.GridHelper(1000, 100, 0x000, 0xccc));

            // Khởi tạo hổ
            for(let i=0; i<15; i++) spawnTiger();
            updateUI();

            // Mobile JoyStick Logic
            let joyId = null, joyStart = {x:0, y:0};
            window.addEventListener('touchstart', e => {
                for(let t of e.changedTouches) {
                    if(t.clientX < window.innerWidth/2 && joyId === null) {
                        joyId = t.identifier; joyStart = {x:t.clientX, y:t.clientY};
                        document.getElementById('joy-base').style.display = 'block';
                        document.getElementById('joy-base').style.left = t.clientX+'px'; document.getElementById('joy-base').style.top = t.clientY+'px';
                    }
                }
            });
            window.addEventListener('touchmove', e => {
                for(let t of e.changedTouches) {
                    if(t.identifier === joyId) {
                        let dx = t.clientX - joyStart.x, dy = t.clientY - joyStart.y;
                        let dist = Math.min(Math.sqrt(dx*dx+dy*dy), 40);
                        let ang = Math.atan2(dy, dx);
                        document.getElementById('joy-stk').style.transform = `translate(${Math.cos(ang)*dist}px, ${Math.sin(ang)*dist}px)`;
                        moveF = -Math.sin(ang) * (dist/40); moveS = -Math.cos(ang) * (dist/40);
                    }
                }
            });
            window.addEventListener('touchend', e => {
                for(let t of e.changedTouches) if(t.identifier === joyId) { joyId = null; moveF = 0; moveS = 0; document.getElementById('joy-base').style.display = 'none'; }
            });
            document.getElementById('fire-btn').ontouchstart = (e) => { e.preventDefault(); shoot(); };
        }

        window.updateWeapon = function() {
            const b64 = document.getElementById('b64-weapon').value;
            if(b64) document.getElementById('weapon-view').src = b64;
        };

        window.updateTiger = function() {
            const b64 = document.getElementById('b64-tiger').value;
            if(b64) {
                new THREE.TextureLoader().load(b64, (tex) => {
                    tigerTex = tex;
                    targets.forEach(t => t.material.map = tex);
                });
            }
        };

        function spawnTiger() {
            const tiger = new THREE.Mesh(new THREE.BoxGeometry(2,2,2), new THREE.MeshStandardMaterial({color: 0xffa500}));
            tiger.position.set((Math.random()-0.5)*150, 1, (Math.random()-0.5)*150);
            tiger.userData = { hp: 1 };
            scene.add(tiger); targets.push(tiger);
        }

        function shoot() {
            const gun = document.getElementById('weapon-view');
            gun.style.transform = 'translateY(15px) rotate(2deg)';
            setTimeout(() => gun.style.transform = 'translateY(0) rotate(0)', 100);

            const ray = new THREE.Raycaster();
            ray.setFromCamera(new THREE.Vector2(0,0), camera);
            const hits = ray.intersectObjects(targets);
            if(hits.length > 0) {
                const t = hits[0].object;
                scene.remove(t); targets = targets.filter(o => o !== t);
                money += 10; updateUI();
            }
        }

        window.updateUI = function() {
            document.getElementById('money').innerText = money;
            document.getElementById('count').innerText = targets.length;
        }

        function animate() {
            requestAnimationFrame(animate);
            const dt = clock.getDelta();

            // PC Di chuyển
            let curF = moveF, curS = moveS;
            if(keys['KeyW']) curF = 1; if(keys['KeyS']) curF = -1;
            if(keys['KeyA']) curS = 1; if(keys['KeyD']) curS = -1;
            if(keys['Space'] && isGrounded) { vVel = 0.4; isGrounded = false; }

            const dir = new THREE.Vector3(); camera.getWorldDirection(dir); dir.y = 0; dir.normalize();
            const side = new THREE.Vector3().crossVectors(dir, camera.up).negate();
            camera.position.addScaledVector(dir, curF * 0.3);
            camera.position.addScaledVector(side, curS * 0.3);

            vVel -= 0.02; camera.position.y += vVel;
            if(camera.position.y < 2) { camera.position.y = 2; vVel = 0; isGrounded = true; }

            // AI Hổ đuổi theo
            targets.forEach(t => {
                if(t.position.distanceTo(camera.position) < 40) {
                    t.position.addScaledVector(new THREE.Vector3().subVectors(camera.position, t.position).normalize(), 0.12);
                    t.lookAt(camera.position);
                }
            });

            renderer.render(scene, camera);
        }

        window.addEventListener('resize', () => {
            camera.aspect = window.innerWidth/window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        });
    </script>
</body>
</html>
