<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>FPS Tiger Hunter</title>
    <style>
        body { margin: 0; overflow: hidden; font-family: sans-serif; touch-action: none; background: #87ceeb; }
        #crosshair {
            position: absolute; top: 50%; left: 50%; width: 30px; height: 30px;
            transform: translate(-50%, -50%); pointer-events: none; z-index: 10;
        }
        #crosshair:before { content: ""; position: absolute; top: 14px; left: 0; width: 30px; height: 2px; background: #00ff00; }
        #crosshair:after { content: ""; position: absolute; left: 14px; top: 0; width: 2px; height: 30px; background: #00ff00; }
        #hud {
            position: absolute; top: 10px; left: 10px; color: white;
            font-size: 20px; font-weight: bold; text-shadow: 2px 2px 4px black; z-index: 10;
        }
        #health-bar-container {
            position: absolute; top: 50px; left: 10px; width: 200px; height: 15px;
            background: rgba(0, 0, 0, 0.5); border: 2px solid white; z-index: 10;
        }
        #health-bar { height: 100%; width: 100%; background: #ff3333; }
        .control-btn {
            position: absolute; width: 80px; height: 80px;
            border: 3px solid rgba(255, 255, 255, 0.6); border-radius: 50%;
            z-index: 20; display: flex; justify-content: center; align-items: center;
            color: white; font-weight: bold; user-select: none; background: rgba(0,0,0,0.5);
        }
        #fire-btn { bottom: 50px; right: 30px; }
        #jump-btn { bottom: 150px; right: 30px; }
        #joystick-base {
            position: absolute; width: 100px; height: 100px; background: rgba(255,255,255,0.2);
            border: 2px solid rgba(255,255,255,0.4); border-radius: 50%; display: none; z-index: 15;
            transform: translate(-50%, -50%);
        }
        #joystick-stick {
            position: absolute; width: 40px; height: 40px; background: rgba(255,255,255,0.5);
            border-radius: 50%; top: 50%; left: 50%; transform: translate(-50%, -50%);
        }
        #overlay {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0, 0, 0, 0.9); display: none; flex-direction: column;
            justify-content: center; align-items: center; z-index: 100; color: white;
        }
        #restart-btn {
            padding: 15px 40px; font-size: 20px; background: #00ff00; color: #000;
            border: none; border-radius: 30px; cursor: pointer; font-weight: bold; margin-top: 20px;
        }
    </style>
</head>
<body>
    <div id="crosshair"></div>
    <div id="hud">Há»• cÃ²n láº¡i: <span id="target-count">0</span></div>
    <div id="health-bar-container"><div id="health-bar"></div></div>
    <div id="joystick-base"><div id="joystick-stick"></div></div>
    <div id="fire-btn" class="control-btn">Báº®N</div>
    <div id="jump-btn" class="control-btn">NHáº¢Y</div>
    <div id="overlay">
        <h1 id="status-text">Dáº§n Ä‘Ã£ tuyá»‡t chá»§ng</h1>
        <button id="restart-btn">CHÆ I Láº I</button>
    </div>

    <script type="module">
        import * as THREE from 'https://cdn.jsdelivr.net/npm/three@0.132.2/build/three.module.js';

        // ðŸš© DÃN BASE64 á»ž ÄÃ‚Y
        const TIGER_IMAGE = 'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAIAAAACCAYAAABytg0kAAAAD0lEQVQIW2Ps/Xv3fwYAAK95Fz6i46kAAAAASUVORK5CYII=';

        let camera, scene, renderer, clock;
        let targets = [], trees = [], playerHealth = 100;
        let moveForward = 0, moveSide = 0, vVel = 0, isGrounded = true;
        let leftId = null, leftStart = {x:0, y:0}, rightId = null, lastRight = {x:0, y:0};

        const raycaster = new THREE.Raycaster();
        const loader = new THREE.TextureLoader();

        init();
        animate();

        function init() {
            scene = new THREE.Scene();
            scene.background = new THREE.Color(0x87ceeb);
            scene.fog = new THREE.Fog(0x87ceeb, 20, 150);

            camera = new THREE.PerspectiveCamera(75, window.innerWidth/window.innerHeight, 0.1, 1000);
            camera.rotation.order = 'YXZ';
            camera.position.set(0, 2, 0);

            scene.add(new THREE.AmbientLight(0xffffff, 0.8));
            const sun = new THREE.DirectionalLight(0xffffff, 1);
            sun.position.set(50, 100, 50);
            scene.add(sun);

            const floor = new THREE.Mesh(new THREE.PlaneGeometry(300, 300), new THREE.MeshLambertMaterial({color: 0xeeeeee}));
            floor.rotation.x = -Math.PI/2;
            scene.add(floor);
            scene.add(new THREE.GridHelper(300, 60, 0x000000, 0xbbbbbb));

            spawnTrees(40);
            spawnTigers(10);

            renderer = new THREE.WebGLRenderer({ antialias: true });
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.setPixelRatio(window.devicePixelRatio);
            document.body.appendChild(renderer.domElement);

            window.addEventListener('touchstart', onTouchStart, {passive: false});
            window.addEventListener('touchmove', onTouchMove, {passive: false});
            window.addEventListener('touchend', onTouchEnd);
            document.getElementById('fire-btn').addEventListener('touchstart', (e) => { e.preventDefault(); shoot(); });
            document.getElementById('jump-btn').addEventListener('touchstart', (e) => { e.preventDefault(); jump(); });
            document.getElementById('restart-btn').addEventListener('click', reset);
            
            clock = new THREE.Clock();
            window.addEventListener('resize', () => {
                camera.aspect = window.innerWidth/window.innerHeight;
                camera.updateProjectionMatrix();
                renderer.setSize(window.innerWidth, window.innerHeight);
            });
        }

        function spawnTrees(n) {
            const trunkGeo = new THREE.CylinderGeometry(0.5, 0.7, 3);
            const trunkMat = new THREE.MeshLambertMaterial({color: 0x5D4037});
            const leafGeo = new THREE.ConeGeometry(3, 8, 8);
            const leafMat = new THREE.MeshLambertMaterial({color: 0x2E7D32});
            for(let i=0; i<n; i++) {
                const g = new THREE.Group();
                const t = new THREE.Mesh(trunkGeo, trunkMat); t.position.y = 1.5;
                const l = new THREE.Mesh(leafGeo, leafMat); l.position.y = 6;
                g.add(t, l);
                g.position.set((Math.random()-0.5)*250, 0, (Math.random()-0.5)*250);
                scene.add(g);
            }
        }

        function spawnTigers(n) {
            const tex = loader.load(TIGER_IMAGE);
            const geo = new THREE.BoxGeometry(2, 2, 2);
            const mat = new THREE.MeshBasicMaterial({map: tex});
            for(let i=0; i<n; i++) {
                const m = new THREE.Mesh(geo, mat);
                m.position.set((Math.random()-0.5)*180, 1, (Math.random()-0.5)*180);
                m.userData = { angle: Math.random()*Math.PI*2, next: 0 };
                scene.add(m);
                targets.push(m);
            }
            document.getElementById('target-count').innerText = targets.length;
        }

        function shoot() {
            raycaster.setFromCamera(new THREE.Vector2(0,0), camera);
            const hits = raycaster.intersectObjects(targets);
            if(hits.length > 0) {
                const obj = hits[0].object;
                scene.remove(obj);
                targets = targets.filter(t => t !== obj);
                document.getElementById('target-count').innerText = targets.length;
                if(targets.length === 0) end("Dáº§n Ä‘Ã£ tuyá»‡t chá»§ng");
            }
        }

        function jump() { if(isGrounded) { vVel = 0.55; isGrounded = false; } }

        function onTouchStart(e) {
            e.preventDefault();
            for(let t of e.changedTouches) {
                if(t.clientX < window.innerWidth/2) {
                    leftId = t.identifier;
                    leftStart = {x: t.clientX, y: t.clientY};
                    const base = document.getElementById('joystick-base');
                    base.style.display = 'block';
                    base.style.left = t.clientX + 'px';
                    base.style.top = t.clientY + 'px';
                } else {
                    rightId = t.identifier;
                    lastRight = {x: t.clientX, y: t.clientY};
                }
            }
        }

        function onTouchMove(e) {
            for(let t of e.changedTouches) {
                if(t.identifier === leftId) {
                    let dx = t.clientX - leftStart.x;
                    let dy = t.clientY - leftStart.y;
                    let dist = Math.min(Math.sqrt(dx*dx + dy*dy), 50);
                    let angle = Math.atan2(dy, dx);
                    moveSide = Math.cos(angle) * (dist/50);
                    moveForward = -Math.sin(angle) * (dist/50);
                    document.getElementById('joystick-stick').style.transform = `translate(calc(-50% + ${Math.cos(angle)*dist}px), calc(-50% + ${Math.sin(angle)*dist}px))`;
                }
                if(t.identifier === rightId) {
                    camera.rotation.y -= (t.clientX - lastRight.x) * 0.007;
                    camera.rotation.x -= (t.clientY - lastRight.y) * 0.007;
                    camera.rotation.x = Math.max(-1.4, Math.min(1.4, camera.rotation.x));
                    lastRight = {x: t.clientX, y: t.clientY};
                }
            }
        }

        function onTouchEnd(e) {
            for(let t of e.changedTouches) {
                if(t.identifier === leftId) {
                    leftId = null; moveForward = 0; moveSide = 0;
                    document.getElementById('joystick-base').style.display = 'none';
                    document.getElementById('joystick-stick').style.transform = 'translate(-50%, -50%)';
                }
                if(t.identifier === rightId) rightId = null;
            }
        }

        function end(txt) {
            document.getElementById('status-text').innerText = txt;
            document.getElementById('overlay').style.display = 'flex';
        }

        function reset() {
            playerHealth = 100;
            document.getElementById('health-bar').style.width = "100%";
            targets.forEach(t => scene.remove(t));
            targets = []; spawnTigers(10);
            camera.position.set(0, 2, 0);
            document.getElementById('overlay').style.display = 'none';
        }

        function animate() {
            requestAnimationFrame(animate);
            const dt = clock.getDelta();

            const dir = new THREE.Vector3(); camera.getWorldDirection(dir); dir.y = 0; dir.normalize();
            const side = new THREE.Vector3().crossVectors(dir, camera.up).negate();
            camera.position.addScaledVector(dir, moveForward * 0.22);
            camera.position.addScaledVector(side, moveSide * 0.22);

            vVel -= 0.025;
            camera.position.y += vVel;
            if(camera.position.y < 2) { camera.position.y = 2; vVel = 0; isGrounded = true; }

            const pPos = new THREE.Vector3(camera.position.x, 1, camera.position.z);
            targets.forEach(tiger => {
                const d = tiger.position.distanceTo(pPos);
                if(d < 25) {
                    tiger.position.addScaledVector(new THREE.Vector3().subVectors(pPos, tiger.position).normalize(), 0.28);
                    tiger.lookAt(pPos);
                    if(d < 2.2) {
                        playerHealth -= 0.6;
                        document.getElementById('health-bar').style.width = playerHealth + "%";
                        if(playerHealth <= 0) end("Báº¡n Ä‘Ã£ bá»‹ há»• vá»“!");
                    }
                } else {
                    if(Date.now() > tiger.userData.next) { tiger.userData.angle = Math.random()*Math.PI*2; tiger.userData.next = Date.now()+2000; }
                    tiger.position.x += Math.cos(tiger.userData.angle) * 0.12;
                    tiger.position.z += Math.sin(tiger.userData.angle) * 0.12;
                    tiger.rotation.y = -tiger.userData.angle;
                }
            });
            renderer.render(scene, camera);
        }
    </script>
</body>
</html>
